<?php $this->yellow->layout("header") ?>
<div class="h-feed archive-container">
    <header class="page-header">
        <h1 class="p-name"><?php echo $this->yellow->page->getHtml("titleContent") ?></h1>
        <?php echo $this->yellow->page->getContentHtml() ?>
    </header>

    <?php 
    // 1. Fetch and group pages in one go
    $pages = $this->yellow->content->index()->filter("layout", "blog")->sort("published", false);
    $groupedPosts = [];
    
    foreach ($pages as $page) {
        $publishedDate = strtotime($page->get("published"));
        $year = date("Y", $publishedDate);
        $month = date("m", $publishedDate);
        $groupedPosts[$year][$month][] = $page;
    }

    // 2. Render Grouped Posts
    foreach ($groupedPosts as $year => $months): 
        // Calculate total posts in this year
        $yearCount = array_reduce($months, function($carry, $item) {
            return $carry + count($item);
        }, 0);
    ?>
    
    <div class="archive-year">
        <h2 id="<?php echo $year ?>">
            <?php echo $year ?>
            <sup class="archive-count"><?php echo $yearCount ?></sup>
        </h2>
        
        <?php foreach ($months as $month => $posts): ?>
            <div class="archive-month">
                <h3 class="archive-month-header">
                    <?php echo date("F", mktime(0, 0, 0, $month, 1)) ?>
                    <span class="archive-count">(<?php echo count($posts) ?>)</span>
                </h3>
                
                <div class="archive-posts">
                    <?php foreach ($posts as $page): ?>
                        <div class="archive-entry">
                            <span class="archive-meta">
                                <?php echo $page->getDateHtml("published", "M j") ?>
                            </span>
                            <a class="entry-link" href="<?php echo $page->getLocation(true) ?>">
                                <?php echo $page->getHtml("title") ?>
                            </a>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
    <?php endforeach; ?>
</div>

<?php $this->yellow->layout("footer") ?>